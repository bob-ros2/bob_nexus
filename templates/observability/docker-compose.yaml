# Observability Stack (Loki, Promtail, Grafana)
services:
  loki:
    image: grafana/loki:latest
    ports:
      - "${OBS_LOKI_PORT:-3100}:3100"
    volumes:
      - ./config/loki.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    ports:
      - "${OBS_PROMTAIL_PORT:-9080}:9080"
    volumes:
      - ${HOST_NEXUS_DIR}:${HOST_NEXUS_DIR}:ro
      - ./config/promtail.yaml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml -config.expand-env=true
    restart: unless-stopped
    environment:
      - HOST_NEXUS_DIR=${HOST_NEXUS_DIR}

  grafana:
    image: grafana/grafana:latest
    ports:
      - "${OBS_GRAFANA_PORT:-3030}:3000"
    volumes:
      - ./config/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
      - ./config/dashboard_provisioning.yaml:/etc/grafana/provisioning/dashboards/nexus.yaml:ro
      - ./config/dashboards:/var/lib/grafana/dashboards:ro
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    restart: unless-stopped
